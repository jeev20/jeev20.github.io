<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jeevith Hegde">
<meta name="dcterms.date" content="2025-09-29">
<meta name="description" content="Fine-tuning with synthetic dataset">

<title>Fine tuning Phi4 model with Unsloth – Automata</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/logo.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ee68a881213748d284c1f4aaa6603bc2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-e03193ba07bae987181549cb47783c22.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/iconify-3.0.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script data-goatcounter="https://86633.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-dark"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = true;
    const darkModeDefault = authorPrefersDark;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Automata</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Fine tuning Phi4 model with Unsloth</h1>
                  <div>
        <div class="description">
          Fine-tuning with synthetic dataset
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">llm fine-tuning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jeevith Hegde </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 29, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#approach" id="toc-approach" class="nav-link" data-scroll-target="#approach">Approach</a></li>
  <li><a href="#synthetic-data-creation" id="toc-synthetic-data-creation" class="nav-link" data-scroll-target="#synthetic-data-creation">Synthetic data creation</a></li>
  <li><a href="#llama.cpp-saving-from-huggingface-to-gguf-format" id="toc-llama.cpp-saving-from-huggingface-to-gguf-format" class="nav-link" data-scroll-target="#llama.cpp-saving-from-huggingface-to-gguf-format">Llama.cpp saving from Huggingface to GGUF format</a>
  <ul class="collapse">
  <li><a href="#using-llamafile-for-quick-fine-tuned-model-inference" id="toc-using-llamafile-for-quick-fine-tuned-model-inference" class="nav-link" data-scroll-target="#using-llamafile-for-quick-fine-tuned-model-inference">Using llamafile for quick fine-tuned model inference</a></li>
  </ul></li>
  <li><a href="#goal-achieved" id="toc-goal-achieved" class="nav-link" data-scroll-target="#goal-achieved">Goal achieved</a>
  <ul class="collapse">
  <li><a href="#fine-tuning-phi4" id="toc-fine-tuning-phi4" class="nav-link" data-scroll-target="#fine-tuning-phi4">Fine-tuning Phi4</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-notebooks"><h2>Notebooks</h2><ul><li><a href="_phi4_FineTuningCustomData-preview.html"><i class="bi bi-journal-code"></i>Fine-tuning Phi4</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<section id="background" class="level1">
<h1>Background</h1>
<p>Using base llm’s even with forced structured outputs, still wont be consistent with required outputs. Using RAG or Prompt engineering for a text extraction usecase does not work well either. For a contextual text extraction usecase there are currently four possible ways with their advantages and disadvantages.</p>
<p><strong>1. Prompt engineering to get the base llm to reply with json strings</strong></p>
<p>This approach is to write very precise prompts (system and user prompts) and try to force the base model to generate responses similar to the required format. This works very poorly for edgecases.</p>
<p><strong>2. Using retrival augmented generation (RAG)</strong></p>
<p>Although a great way to build context aware systems, RAG is rather poorly suited when the content of the entire text has to be read to extract required text. RAG can ignore parts of the document if the query engine is not robust, if not all relevant text is extracted, then we may not parse the important part of the input text.</p>
<p><strong>3. Prompt engineering + structured output using pydantic class of the required output</strong></p>
<p>Here we combine both prompt engineering and force the model to only return required response. Pydantic classes define the output schema, which also validates if the generated response. This is the second best way to create text extraction workflows using llms.</p>
<p><strong>4. Instruction based fine-tuning the base llm model</strong> ⭐</p>
<p>Here we take a small part of the model and retrain that part with our custom dataset, which resembles our real usecase. In addition, after fine-tuning, we are not bound to create detailed system or user prompts. The fine-tuned model already would have learnt to extract relevant fields. A pydantic class can still be used to validated the generated output, but we would have fundamentally changed the output</p>
</section>
<section id="approach" class="level1">
<h1>Approach</h1>
<p>In past two weeks, I have been exploring the field of fine-tuning of large language models using various SOTA frameworks. I have explored fine-tuning using <a href="https://unsloth.ai/">unsloth</a>, <a href="https://huggingface.co/docs/transformers/training">transformers</a> and <a href="https://axolotl.ai/">axolotl</a>. I found axolotl to be quite complex but it had ability to distribute training across multiple GPUs. Transformers module was second most complex as there were many different approaches which could be used in this library.</p>
<p>I finally settled with Unsloth, clearly because it was easy to start with and had many turnkey jupyter notebooks to use. That said, a big negative is that the api for multi-gpu fine-tuning is still not roboust enough in 2025. Without a hefty GPU on my <a href="https://jeev20.github.io/posts/buildingapowerfulenoughlocalaiserver/">LLM server</a>, unsloth would just keep crashing with the usual <code>cuda out of memory</code> error. I previously had two RTX 3060 each with 12 Gb VRAM.</p>
<p>My server now is upgraded with a RTX 3090 which has a massive 24GB of Vram. This opened up many oppurtunities to learn fine-tuning of llm using unsloth. I finally understood and implemented fine-tuned model on a reallife use case. The model I learnt fine-tuning on was phi4 by microsoft and modified by Unsloth which also works well for structured output generation. The idea was to implement a task-specific tuning for a usecase at work.</p>
<p>I studied the jupyter notebook from <a href="https://colab.research.google.com/github/unslothai/notebooks/blob/main/nb/Phi_4-Conversational.ipynb#scrollTo=AX734MS139kk">unsloth showing fine-tuning of phi4 model</a> and modified parts of it.</p>
</section>
<section id="synthetic-data-creation" class="level1">
<h1>Synthetic data creation</h1>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>To ensure my training data had good volume and variation, I used Google’s <strong>Gemini Pro 2.5</strong> to help create a python script to programatically generate synthetic data with a given format.</p>
</div>
</div>
</div>
<p>These key-value pairs would then be used to fine-tune the model.<br>
I choose to keep things simple and opted for a well known <code>jsonl</code>format. <code>jsonl</code> format is similar to <code>json</code> but each line is a valid <code>json</code> string without an trailing comma.</p>
<p>To create a look-alike dataset I used the <code>faker</code> module in python and created the <code>jsonl</code> file programatically. This allows me to scale the training dataset to any number I wish. For example, to create 10000 datapoints, I use the following command:</p>
<details>
<summary>
synthetic_data_generator.py
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> faker <span class="im">import</span> Faker</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Faker for English (US) data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>fake <span class="op">=</span> Faker(<span class="st">'en_US'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Predefined lists for variability</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>ROLES <span class="op">=</span> [<span class="st">'Patient'</span>, <span class="st">'User'</span>, <span class="st">'Client'</span>, <span class="st">'Customer'</span>, <span class="st">'Employee'</span>, <span class="st">'Child'</span>, <span class="st">'Neighbor'</span>, <span class="st">'Driver'</span>, <span class="st">'Participant'</span>]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>HEALTH_INFO_TYPES <span class="op">=</span> [<span class="st">'Diagnosis'</span>, <span class="st">'Assessment'</span>, <span class="st">'Follow-up'</span>, <span class="st">'Specialist-assessment'</span>, <span class="st">'Hospital-stay'</span>, <span class="st">'Medication'</span>, <span class="st">'Blood-sample'</span>, <span class="st">'Progress-report'</span>, <span class="st">'Root-canal'</span>, <span class="st">'Therapy-session'</span>, <span class="st">'Vaccination'</span>, <span class="st">'Check-up'</span>, <span class="st">'Symptoms'</span>]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>CATEGORIES <span class="op">=</span> [</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'race or ethnic origin'</span>],</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'political opinions'</span>],</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'religion'</span>],</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'philosophical beliefs'</span>],</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'trade union membership'</span>],</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'genetic data'</span>],</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'biometric data'</span>],</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'health information'</span>],</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'sexual relations'</span>],</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'sexual orientation'</span>],</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    []</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>GENDERS <span class="op">=</span> [<span class="st">'Male'</span>, <span class="st">'Female'</span>]</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_valid_ssn():</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates a valid US Social Security Number (SSN).</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fake.ssn()</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_english_text(num_paragraphs<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates paragraphs of plausible, English text without adding new PII.</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    text_parts <span class="op">=</span> []</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_paragraphs):</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        paragraph <span class="op">=</span> []</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(random.randint(<span class="dv">5</span>, <span class="dv">10</span>)):</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>            templates <span class="op">=</span> [</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"The report from </span><span class="sc">{</span>fake<span class="sc">.</span>city()<span class="sc">}</span><span class="ss"> mentions that </span><span class="sc">{</span>fake<span class="sc">.</span>catch_phrase()<span class="sc">}</span><span class="ss">."</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"The project, led by </span><span class="sc">{</span>fake<span class="sc">.</span>company()<span class="sc">}</span><span class="ss">, focuses on </span><span class="sc">{</span>fake<span class="sc">.</span>bs()<span class="sc">}</span><span class="ss">."</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"The assessment is based on data from </span><span class="sc">{</span>fake<span class="sc">.</span>day_of_week()<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>fake<span class="sc">.</span>day_of_month()<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>fake<span class="sc">.</span>month_name()<span class="sc">}</span><span class="ss">."</span>,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"The results show a clear trend according to </span><span class="sc">{</span>fake<span class="sc">.</span>bs()<span class="sc">}</span><span class="ss">."</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"A solution for </span><span class="sc">{</span>fake<span class="sc">.</span>bs()<span class="sc">}</span><span class="ss"> was discussed during the meeting."</span>,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Future focus will be on </span><span class="sc">{</span>fake<span class="sc">.</span>bs()<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>            paragraph.append(random.choice(templates))</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        text_parts.append(<span class="st">" "</span>.join(paragraph))</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(text_parts)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_ssn(ssn):</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co">    Formats a US SSN in one of three ways.</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    formats <span class="op">=</span> [</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> s: s,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> s: <span class="ss">f"</span><span class="sc">{</span>s[:<span class="dv">3</span>]<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>s[<span class="dv">3</span>:<span class="dv">5</span>]<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>s[<span class="dv">5</span>:]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> s: <span class="ss">f"SSN: </span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> random.choice(formats)(ssn)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_person_data():</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generates a dictionary for a single person."""</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    person <span class="op">=</span> {</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: fake.name(),</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"address"</span>: fake.address().replace(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>, <span class="st">', '</span>),</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gender"</span>: random.choice(GENDERS),</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"phone_number"</span>: fake.phone_number(),</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span>: <span class="bu">str</span>(random.randint(<span class="dv">15</span>, <span class="dv">85</span>)),</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ssn"</span>: generate_valid_ssn(),</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span>: random.choice(ROLES),</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"health_info_type"</span>: random.choice(HEALTH_INFO_TYPES),</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"personal_data_categories"</span>: random.choice(CATEGORIES)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    keys_to_null <span class="op">=</span> random.sample([k <span class="cf">for</span> k <span class="kw">in</span> person.keys() <span class="cf">if</span> k <span class="op">!=</span> <span class="st">'name'</span>], k<span class="op">=</span>random.randint(<span class="dv">0</span>, <span class="dv">4</span>))</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> keys_to_null:</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>        person[key] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> person.get(<span class="st">'personal_data_categories'</span>) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        person[<span class="st">'personal_data_categories'</span>] <span class="op">=</span> []</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> person</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_multi_person_data():</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generates a data point with multiple people."""</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    num_people <span class="op">=</span> random.randint(<span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    persons_list <span class="op">=</span> [generate_person_data() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_people)]</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    human_text_parts <span class="op">=</span> [<span class="st">"Medical record concerning multiple individuals."</span>]</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, person <span class="kw">in</span> <span class="bu">enumerate</span>(persons_list):</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        human_text_parts.append(<span class="ss">f"</span><span class="ch">\n\n</span><span class="ss">--- Person </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>person<span class="sc">.</span>get(<span class="st">'name'</span>) <span class="kw">or</span> <span class="st">'Unknown Name'</span><span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> person.get(<span class="st">'ssn'</span>):</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="ss">f"SSN: </span><span class="sc">{</span>format_ssn(person[<span class="st">'ssn'</span>])<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> person.get(<span class="st">'age'</span>):</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="ss">f"Age: </span><span class="sc">{</span>person[<span class="st">'age'</span>]<span class="sc">}</span><span class="ss"> years."</span>)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> person.get(<span class="st">'address'</span>):</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="ss">f"Address: </span><span class="sc">{</span>person[<span class="st">'address'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> person.get(<span class="st">'personal_data_categories'</span>):</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>            category <span class="op">=</span> person[<span class="st">'personal_data_categories'</span>][<span class="dv">0</span>] <span class="cf">if</span> person[<span class="st">'personal_data_categories'</span>] <span class="cf">else</span> <span class="st">'unspecified'</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="ss">f"The record contains sensitive information about the person's </span><span class="sc">{</span>category<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    long_text <span class="op">=</span> generate_english_text(num_paragraphs<span class="op">=</span><span class="dv">2</span>).split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    human_text_parts.append(<span class="st">"</span><span class="ch">\n\n</span><span class="st">**Joint Assessment**"</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    human_text_parts.append(long_text[<span class="dv">0</span>])</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    human_text_parts.append(<span class="st">"</span><span class="ch">\n</span><span class="st">**Observations**"</span>)</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    human_text_parts.append(long_text[<span class="dv">1</span>])</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    human_text <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(human_text_parts)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    gpt_json <span class="op">=</span> {<span class="st">"PersonSensitiveInformation"</span>: persons_list}</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> human_text, gpt_json</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_data_point():</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates a single synthetic data point, which includes a human-readable text</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="co">    and a corresponding structured JSON output for a GPT-like model.</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>    SHORT_IRRELEVANT_QUESTIONS <span class="op">=</span> [</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        <span class="st">"What time is it?"</span>,</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Can you tell me a joke?"</span>,</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        <span class="st">"What is the capital of the United States?"</span>,</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>        <span class="st">"How is the weather today?"</span>,</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Thanks for the help."</span>,</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OK."</span>,</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Alright."</span>,</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Who are you?"</span>,</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"What can you do?"</span>,</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Tell me something interesting."</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> random.random() <span class="op">&lt;</span> <span class="fl">0.25</span>:  <span class="co"># 25% chance for multiple people</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>        human_text, gpt_json <span class="op">=</span> generate_multi_person_data()</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>        choice_type <span class="op">=</span> random.choices([<span class="st">'full_partial'</span>, <span class="st">'no_sensitive_info'</span>, <span class="st">'irrelevant'</span>, <span class="st">'short_irrelevant'</span>], [<span class="fl">0.48</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.07</span>])[<span class="dv">0</span>]</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> choice_type <span class="op">==</span> <span class="st">'irrelevant'</span>:</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>            human_text <span class="op">=</span> generate_english_text(num_paragraphs<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>            gpt_json <span class="op">=</span> {<span class="st">"PersonSensitiveInformation"</span>: [{<span class="st">"name"</span>: <span class="va">None</span>, <span class="st">"address"</span>: <span class="va">None</span>, <span class="st">"gender"</span>: <span class="va">None</span>, <span class="st">"phone_number"</span>: <span class="va">None</span>, <span class="st">"age"</span>: <span class="va">None</span>, <span class="st">"ssn"</span>: <span class="va">None</span>, <span class="st">"role"</span>: <span class="st">"Unknown"</span>, <span class="st">"health_info_type"</span>: <span class="va">None</span>, <span class="st">"personal_data_categories"</span>: []}]}</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> choice_type <span class="op">==</span> <span class="st">'short_irrelevant'</span>:</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>            human_text <span class="op">=</span> random.choice(SHORT_IRRELEVANT_QUESTIONS)</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>            gpt_json <span class="op">=</span> {<span class="st">"PersonSensitiveInformation"</span>: [{<span class="st">"name"</span>: <span class="va">None</span>, <span class="st">"address"</span>: <span class="va">None</span>, <span class="st">"gender"</span>: <span class="va">None</span>, <span class="st">"phone_number"</span>: <span class="va">None</span>, <span class="st">"age"</span>: <span class="va">None</span>, <span class="st">"ssn"</span>: <span class="va">None</span>, <span class="st">"role"</span>: <span class="st">"Unknown"</span>, <span class="st">"health_info_type"</span>:<span class="va">None</span>, <span class="st">"personal_data_categories"</span>: []}]}</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> choice_type <span class="op">==</span> <span class="st">'no_sensitive_info'</span>:</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>            human_text <span class="op">=</span> <span class="st">"Medical record for a patient who wishes to remain anonymous. No personally identifiable information is recorded.</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> generate_english_text(num_paragraphs<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>            gpt_json <span class="op">=</span> {<span class="st">"PersonSensitiveInformation"</span>: [{<span class="st">"name"</span>: <span class="va">None</span>, <span class="st">"address"</span>: <span class="va">None</span>, <span class="st">"gender"</span>: <span class="va">None</span>, <span class="st">"phone_number"</span>: <span class="va">None</span>, <span class="st">"age"</span>: <span class="va">None</span>, <span class="st">"ssn"</span>: <span class="va">None</span>, <span class="st">"role"</span>: <span class="st">"Patient"</span>, <span class="st">"health_info_type"</span>: <span class="va">None</span>, <span class="st">"personal_data_categories"</span>: []}]}</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: <span class="co"># full_partial</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> generate_person_data()</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>            human_text_parts <span class="op">=</span> [<span class="ss">f"Patient record for </span><span class="sc">{</span>person[<span class="st">'name'</span>] <span class="kw">or</span> <span class="st">'a named person'</span><span class="sc">}</span><span class="ss">."</span>]</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'ssn'</span>):</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>                formatted_ssn <span class="op">=</span> format_ssn(person[<span class="st">'ssn'</span>])</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"SSN: </span><span class="sc">{</span>formatted_ssn<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'age'</span>):</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"The patient is a </span><span class="sc">{</span>person[<span class="st">'age'</span>]<span class="sc">}</span><span class="ss"> year old </span><span class="sc">{</span>person[<span class="st">'gender'</span>]<span class="sc">.</span>lower() <span class="cf">if</span> person<span class="sc">.</span>get(<span class="st">'gender'</span>) <span class="cf">else</span> <span class="st">'person'</span><span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'address'</span>):</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"Registered home address is </span><span class="sc">{</span>person[<span class="st">'address'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'phone_number'</span>):</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"For quick communication, the mobile number is </span><span class="sc">{</span>person[<span class="st">'phone_number'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'role'</span>):</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"In this record, their role is as a </span><span class="sc">{</span>person[<span class="st">'role'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'personal_data_categories'</span>):</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>                category <span class="op">=</span> person[<span class="st">'personal_data_categories'</span>][<span class="dv">0</span>] <span class="cf">if</span> person[<span class="st">'personal_data_categories'</span>] <span class="cf">else</span> <span class="st">'unspecified'</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"The record contains sensitive information regarding the person's </span><span class="sc">{</span>category<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>            long_text <span class="op">=</span> generate_english_text(num_paragraphs<span class="op">=</span><span class="dv">3</span>).split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="st">"</span><span class="ch">\n\n</span><span class="st">**General Assessment**"</span>)</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(long_text[<span class="dv">0</span>])</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="st">"</span><span class="ch">\n</span><span class="st">**History**"</span>)</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="ss">f"Previous illnesses include </span><span class="sc">{</span>fake<span class="sc">.</span>bs()<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>fake<span class="sc">.</span>bs()<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(long_text[<span class="dv">1</span>])</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="st">"</span><span class="ch">\n</span><span class="st">**Current Status**"</span>)</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> person.get(<span class="st">'health_info_type'</span>):</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>                human_text_parts.append(<span class="ss">f"The main focus for this journal entry is a recent </span><span class="sc">{</span>person[<span class="st">'health_info_type'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(long_text[<span class="dv">2</span>])</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="st">"</span><span class="ch">\n</span><span class="st">**Treatment Plan and Confidentiality**"</span>)</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="st">"It is important that all information is treated confidentially. The patient has given their consent for information exchange between involved healthcare personnel."</span>)</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>            human_text_parts.append(<span class="ss">f"The record was entered by Dr. </span><span class="sc">{</span>fake<span class="sc">.</span>last_name()<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>fake<span class="sc">.</span>company()<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>            human_text <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(human_text_parts)</span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>            gpt_json <span class="op">=</span> {<span class="st">"PersonSensitiveInformation"</span>: [person]}</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>    conversation <span class="op">=</span> {</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>        <span class="st">"conversations"</span>: [</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"from"</span>: <span class="st">"human"</span>, <span class="st">"value"</span>: human_text},</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"from"</span>: <span class="st">"gpt"</span>, <span class="st">"value"</span>: json.dumps(gpt_json, ensure_ascii<span class="op">=</span><span class="va">False</span>)}</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dumps(conversation, ensure_ascii<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a><span class="co">    Main function to generate a specified number of synthetic data points.</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Generate synthetic data for LLM fine-tuning."</span>)</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">"n"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Number of data points to generate."</span>)</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(args.n):</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(generate_data_point())</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>training_samples <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv run synth_data_creator.py {training_samples} <span class="op">&gt;</span> input_dataset<span class="op">/</span>synth_training_data_{training_samples}.jsonl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details>
<summary>
An example datapoint from the dataset
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"conversations"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"from"</span><span class="fu">:</span> <span class="st">"human"</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"Patient journal for Ola Nordmann. Date of birth: April 12, 1990. The patient is a 35-year-old man. He is registered with a residential address at Storgata 1, 0155 Oslo. For quick communication, his mobile number is 91234567. The complete national ID number is 12049012345. In this journal, Ola Nordmann's role is as a patient. The main focus of this journal entry is a recent diagnosis. This information is categorized under health information. The patient's medical history includes previous treatment for heart and vascular diseases, and the new diagnosis is related to this. It is important that all information is handled confidentially and in accordance with current privacy legislation. The patient has given his consent for healthcare professionals involved in treatment to exchange necessary information. The further treatment plan will be developed in collaboration with the patient to ensure a common understanding and agreement on the way forward. It is crucial for the treatment outcome that the patient feels heard and respected. A follow-up appointment is scheduled in three months to assess the effect of the measures implemented. The patient has also been informed about lifestyle changes that may have a positive impact on his health condition, including diet and physical activity. He has expressed motivation to follow the given recommendations. The journal is maintained by Dr. Hansen, Oslo University Hospital, and is dated August 15, 2025. Further notes from conversations and examinations will be added continuously. There are no other categories of personal information that are relevant to this specific journal entry. All processing of personal information takes place in accordance with GDPR and national guidelines for the healthcare sector. It is important to emphasize that the patient's dignity and privacy are of the highest priority in all our activities. Future consultations will be based on the information documented here, and it is therefore essential that the journal is accurate and up-to-date. The patient has the right to access his own journal and can request correction of any errors. This is a fundamental patient right that we are committed to respecting."</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"from"</span><span class="fu">:</span> <span class="st">"gpt"</span><span class="fu">,</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"{</span><span class="ch">\"</span><span class="st">PersonSensitiveInformasjon</span><span class="ch">\"</span><span class="st">:[{</span><span class="ch">\"</span><span class="st">name</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">Ola Nordmann</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">address</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">Storgata 1, 0155 Oslo</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">gender</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">Male</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">mobile_number</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">91234567</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">age</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">35</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">national_id_number</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">12049012345</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">role</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">Patient</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">type_of_health_information</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">Diagnosis</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">categories_of_personal_information</span><span class="ch">\"</span><span class="st">:[</span><span class="ch">\"</span><span class="st">health information</span><span class="ch">\"</span><span class="st">]}]}"</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>The above input dataset is later converted to a usuable format by using unsloths <code>standardize_sharegpt</code> module.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> unsloth.chat_templates <span class="im">import</span> standardize_sharegpt</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> standardize_sharegpt(dataset)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> dataset.<span class="bu">map</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    formatting_prompts_func,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    batched<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This results in the following format which is further used by training logic.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="kw">|</span><span class="ex">im_start</span><span class="kw">|</span><span class="op">&gt;</span>user<span class="op">&lt;</span><span class="kw">|</span><span class="ex">im_sep</span><span class="kw">|</span><span class="op">&gt;</span>Patient <span class="ex">journal</span> for Ola Nordmann. Date of birth: April 12, 1990. The patient is a 35-year-old man. He is registered with a residential address at Storgata 1, 0155 Oslo. For quick communication, his mobile number is 91234567. The complete national ID number is 12049012345. In this journal, Ola Nordmann<span class="st">'s role is as a patient. The main focus of this journal entry is a recent diagnosis. This information is categorized under health information. The patient'</span>s medical history includes previous treatment for heart and vascular diseases, and the new diagnosis is related to this. It is important that all information is handled confidentially and in accordance with current privacy legislation. The patient has given his consent for healthcare professionals involved in treatment to exchange necessary information. The further treatment plan will be developed in collaboration with the patient to ensure a common understanding and agreement on the way forward. It is crucial for the treatment outcome that the patient feels heard and respected. A follow-up appointment is scheduled in three months to assess the effect of the measures implemented. The patient has also been informed about lifestyle changes that may have a positive impact on his health condition, including diet and physical activity. He has expressed motivation to follow the given recommendations. The journal is maintained by Dr. Hansen, Oslo University Hospital, and is dated August 15, 2025. Further notes from conversations and examinations will be added continuously. There are no other categories of personal information that are relevant to this specific journal entry. All processing of personal information takes place in accordance with GDPR and national guidelines for the healthcare sector. It is important to emphasize that the patient<span class="st">'s dignity and privacy are of the highest priority in all our activities. Future consultations will be based on the information documented here, and it is therefore essential that the journal is accurate and up-to-date. The patient has the right to access his own journal and can request correction of any errors. This is a fundamental patient right that we are committed to respecting.&lt;|im_end|&gt;&lt;|im_start|&gt;assistant&lt;|im_sep|&gt;{\"PersonSensitiveInformasjon\":[{\"name\":\"Ola Nordmann\",\"address\":\"Storgata 1, 0155 Oslo\",\"gender\":\"Male\",\"mobile_number\":\"91234567\",\"age\":\"35\",\"national_id_number\":\"12049012345\",\"role\":\"Patient\",\"type_of_health_information\":\"Diagnosis\",\"categories_of_personal_information\":[\"health information\"]}]}&lt;|im_end|&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="llama.cpp-saving-from-huggingface-to-gguf-format" class="level1">
<h1>Llama.cpp saving from Huggingface to GGUF format</h1>
<p>Once the training was complete, I kept running into a bug in Unsloth which kept pointing at llama.ccp to be the cause. The error I kept getting was:</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>RuntimeError: Unsloth: The file ‘llama.cpp/llama-quantize’ or <code>llama.cpp/quantize</code> does not exist.</p>
<p>We’ve also double checked the building directory under ‘llama.cpp/build/bin/’.</p>
<p>But we expect this file to exist! Check if the file exists under llama.cpp and investigate the building process of llama.cpp (make/cmake)!</p>
</div>
</div>
<p>I observed that if we have previous outputs/models and llama.cpp folder the notebook fails to run. So I delete these two folders first.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># List of folder paths you want to delete</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>folders_to_delete <span class="op">=</span> [<span class="st">"model"</span>, <span class="st">"llama.cpp"</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> folder <span class="kw">in</span> folders_to_delete:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(folder) <span class="kw">and</span> os.path.isdir(folder):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        shutil.rmtree(folder)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Deleted: </span><span class="sc">{</span>folder<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Folder not found or not a directory: </span><span class="sc">{</span>folder<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then I run this in the notebook cell as well</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">!sudo</span> apt-get install libcurl4-openssl-dev</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">!git</span> clone <span class="at">--recursive</span> https://github.com/ggerganov/llama.cpp</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">!cd</span> llama.cpp <span class="kw">&amp;&amp;</span> <span class="fu">cmake</span> <span class="at">-B</span> build <span class="kw">&amp;&amp;</span> <span class="fu">cmake</span> <span class="at">--build</span> build <span class="at">--config</span> Release</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>After the build, I observe the file <code>llama.cpp/build/bin/llama-quantize</code> exits and Unsloth can use this to create the GFUF file.</p>
<section id="using-llamafile-for-quick-fine-tuned-model-inference" class="level2">
<h2 class="anchored" data-anchor-id="using-llamafile-for-quick-fine-tuned-model-inference">Using llamafile for quick fine-tuned model inference</h2>
<p>I like the llamafile project a lot and use it to quickly run the <code>.gguf</code> model. You can read more about how to use <a href="https://jeev20.github.io/posts/creatingacustomllamafile/">llamafile here.</a></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./llamafile-0.9.3</span> <span class="at">-ngl</span> 9999 <span class="at">--gpu</span> nvidia  <span class="at">--temp</span> 0 <span class="at">-m</span> unsloth.Q4_K_M.gguf <span class="at">--cli</span> <span class="at">-p</span> <span class="st">'Journal note concerning several people.\n\n\n--- Person 1: Rita-Karoline Mathisen ---\nNational ID number: 05 03 78 26997.\nAge: 37 years.\nAddress: Isaksenholtet 015, 6433 Ali.\n\n\n--- Person 2: Lise Eide ---\nNational ID number: 09088128149.\nAge: 64.\nAddress: Johnsentoppen 8, 3724 Leiffjell.\n\n\n--- Person 3: Frode Tangen ---\nNational ID number: 291165 44472.\nAddress: Alilia 3F, 0202 Erlingfoss.\n\nReport source: Sivmark\nAssessment Topic: Reactive multi-tasking hierarchy\nProject Lead: Ahmed-Evensen &amp; co.\nFocus: evolving front-end initiatives\nAssessment Date: February 1st\nTrend: unleashing out-of-the-box systems\nSolution Discussed: meshing efficient relationships\nFuture Focus: leveraging intuitive technologies\n\nReport source: Trondborg\nAssessment Topic: Fully-configurable contextually-based groupware\nProject Lead: Sørensen and Sønner\nFocus: streamlining dynamic deliverables\nAssessment Date: September 6th\nTrend: branding efficient interfaces\nSolution Discussed: driving real-time initiatives\nFuture Focus: redefining customized e-business\n\nReport source: Lien\nAssessment Topic: Ameliorated coherent circuit\nProject Lead: Hagen and Sønner\nFocus: leveraging synergistic applications\nAssessment Date: December 29th\nTrend: enhancing 24/365 relationships\nSolution Discussed: synergizing global systems\nFuture Focus: empowering vertical mindshare\n\nReport source: Unnistad\nAssessment Topic: Organized optimal policy\nProject Lead: Strøm-Iversen BA\nFocus: productizing global web-readiness\nAssessment Date: June 10th\nTrend: strategizing B2B e-commerce\nSolution Discussed: e-enabling cutting-edge paradigms\nFuture Focus: redefining strategic schemas\n\nReport source: Vik\nAssessment Topic: Right-sized multi-state emulation\nProject Lead: Ali and Sønner\nFocus: harnessing extensible info-mediaries\nAssessment Date: October 08\nTrend: visualizing magnetic technologies\nSolution Discussed: whiteboarding intuitive ROI\nFuture Focus: facilitating compelling web-readiness\n\nReport source: Trondsund\nAssessment Topic: Sharable regional flexibility\nProject Lead: Berge, Engen and Hauge\nFocus: utilizing front-end vortals\nAssessment Date: February 24th\nTrend: deploying dynamic eyeballs\nSolution Discussed: productizing granular niches\nFuture Focus: transforming collaborative e-business\n\nReport source: Wenchesund\nAssessment Topic: Right-sized well-modulated emulation\nProject Lead: Abrahamsen-Ødegård\nFocus: incentivizing turn-key vortals\nAssessment Date: January 05\nTrend: visualizing end-to-end e-services\nSolution Discussed: delivering 24/7 deliverables\nFuture Focus: optimizing B2B markets.\n\nObservations\n\nReport source: Alexanderby\nAssessment Topic: Phased 24hour info-mediaries\nProject Lead: Gundersen and Sønner\nFocus: driving out-of-the-box methodologies\nAssessment Date: December 16th\nTrend: transitioning out-of-the-box channels\nSolution Discussed: unleashing rich technologies\nFuture Focus: extending strategic niches\n\nReport source: Egilfjell\nAssessment Topic: Expanded bi-directional productivity\nProject Lead: Solheim BA\nFocus: generating magnetic schemas\nAssessment Date: February 06\nTrend: enabling mission-critical web-readiness\nSolution Discussed: re-intermediating ubiquitous solutions\nFuture Focus: integrating ubiquitous platforms\n\nReport source: Pervær\nAssessment Topic: Customer-focused holistic software\nProject Lead: Aasen &amp; co.\nFocus: synergizing end-to-end e-tailers\nAssessment Date: August 06\nTrend: matrixing integrated e-services\nSolution Discussed: integrating ubiquitous e-services\nFuture Focus: envisioning intuitive eyeballs\n\nReport source: Lien\nAssessment Topic: Integrated modular core\nProject Lead: Næss, Aune and Nilsen\nFocus: evolving wireless paradigms\nAssessment Date: February 25th\nTrend: re-contextualizing strategic schemas\nSolution Discussed: architecting back-end bandwidth\nFuture Focus: engineering cutting-edge action-items\n\nReport source: Torbjørnstrøm\nAssessment Topic: Persevering 5thgeneration customer loyalty\nProject Lead: Hansen &amp; co.\nFocus: aggregating customized systems\nAssessment Date: April 07\nTrend: aggregating sticky web services\nSolution Discussed: re-contextualizing distributed interfaces\nFuture Focus: syndicating e-business architectures'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The response is for multi persons found in the text.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SensitiveInformation"</span><span class="ex">:</span> [</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span><span class="ex">:</span> <span class="st">"Rita-Karoline Mathisen"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"address"</span><span class="ex">:</span> <span class="st">"Isaksenholtet 015, 6433 Ali"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gender"</span><span class="ex">:</span> <span class="st">"Female"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mobile_number"</span><span class="ex">:</span> <span class="st">"45 05 05 63"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span><span class="ex">:</span> <span class="st">"37"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"national_id_number"</span><span class="ex">:</span> <span class="st">"05037826997"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span><span class="ex">:</span> <span class="st">"Customer"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type_of_health_information"</span><span class="ex">:</span> <span class="st">"Diagnosis"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"categories_of_personal_information"</span><span class="ex">:</span> [</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sexual relationships"</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">{</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span><span class="ex">:</span> <span class="st">"Lise Eide"</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"address"</span><span class="ex">:</span> <span class="st">"Johnsentoppen 8, 3724 Leiffjell"</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gender"</span><span class="ex">:</span> <span class="st">"Female"</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mobile_number"</span><span class="ex">:</span> <span class="st">"98 05 05 63"</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span><span class="ex">:</span> <span class="st">"64"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"national_id_number"</span><span class="ex">:</span> <span class="st">"09088128149"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span><span class="ex">:</span> <span class="st">"Customer"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type_of_health_information"</span><span class="ex">:</span> <span class="st">"Diagnosis"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"categories_of_personal_information"</span><span class="ex">:</span> [</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>          <span class="st">"philosophical beliefs"</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      <span class="ex">},</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">{</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span><span class="ex">:</span> <span class="st">"Frode Tangen"</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"address"</span><span class="ex">:</span> <span class="st">"Alilia 3F, 0202 Erlingfoss"</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gender"</span><span class="ex">:</span> <span class="st">"Female"</span>,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mobile_number"</span><span class="ex">:</span> <span class="st">"98 05 05 63"</span>,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"age"</span><span class="ex">:</span> null,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"national_id_number"</span><span class="ex">:</span> <span class="st">"29116544472"</span>,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span><span class="ex">:</span> <span class="st">"Customer"</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type_of_health_information"</span><span class="ex">:</span> <span class="st">"Diagnosis"</span>,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"categories_of_personal_information"</span><span class="ex">:</span> [</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>          <span class="st">"philosophical beliefs"</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="ex">]</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="goal-achieved" class="level1">
<h1>Goal achieved</h1>
<p>So we started with Phi4 model and now fine-tuned it to only respond with a json string which we want. Another advantage is that I did not need to specify a system or a user prompt to get the correct structured output.</p>
<p>I can use this learning to replicate the same process to any open-source LLM (text to text). I now want to learn fine-tuning of other modals, starting with image-to-text LLM fine-tuning.</p>
<section id="fine-tuning-phi4" class="level2 quarto-embed-nb-cell">
<h2 class="anchored" data-anchor-id="fine-tuning-phi4">Fine-tuning Phi4</h2>
<a class="quarto-notebook-link" id="nblink-1" href="_phi4_FineTuningCustomData-preview.html#bae48eda">Source: Fine-tuning Phi4</a></section>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jeev20\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="dark">
<input type="hidden" id="giscus-alt-theme" value="light">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "jeev20/jeev20.github.io";
    script.dataset.repoId = "R_kgDOL9EtQw";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOL9EtQ84CfcOd";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://quarto.org">
<p>Made with <iconify-icon role="img" inline="" icon="simple-icons:quarto" style="color:#74aadb;" aria-label="Quarto icon" title="Quarto icon" width="1.2em" height="1.2em" flip="horizontal" rotate="0deg" mode="svg"></iconify-icon>uarto</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>